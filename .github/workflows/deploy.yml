name: Deploy to Dokku (via VPN)

on:
  push:
    paths:
      - 'deployment-manifest.yaml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # needed so we can diff against previous commit

      - name: Extract updated services from manifest
        id: manifest
        run: |
          # Get changed services by diffing manifest
          CHANGED_SERVICES=$(git diff HEAD^ HEAD -- deployment-manifest.yaml | \
            grep -E '^[+-]\s+[a-zA-Z0-9._-]+:' | \
            sed -E 's/^[+-]\s*([^:]+):.*/\1/' | awk '!seen[$0]++' | tr '\n' ' ')

          echo "CHANGED_SERVICES=$CHANGED_SERVICES" >> $GITHUB_ENV

          echo "üîç Services changed in manifest:"
          echo "$CHANGED_SERVICES"

      - name: VPN Connect
        uses: igdevx/l2tp-ipsec-vpn-action@v2
        id: vpn
        with:
          vpn_gateway: ${{ secrets.VPN_GATEWAY }}
          vpn_psk: ${{ secrets.VPN_PSK }}
          vpn_username: ${{ secrets.VPN_USERNAME }}
          vpn_password: ${{ secrets.VPN_PASSWORD }}
          vpn_nt_domain: ${{ secrets.VPN_NT_DOMAIN }}
          vpn_ike: ${{ secrets.VPN_IKE }}
          vpn_esp: ${{ secrets.VPN_ESP }}

      - name: VPN route IP setup
        run: |
          HOST_IP=$(nslookup ${{ secrets.DOKKU_HOST }} | awk '/^Address: / { print $2 }' | tail -n1)
          IFACE="${{ steps.vpn.outputs.ppp_interface }}"

          sudo ip route add "$HOST_IP" dev "$IFACE"

      - name: SSH key setup
        run: |
          mkdir -p ~/.ssh
          cat <<EOF > ~/.ssh/id_ed25519
          ${{ secrets.DOKKU_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/id_ed25519
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.DOKKU_HOST }}" >> ~/.ssh/known_hosts || { echo "‚ùå ssh-keyscan failed"; exit 1; }

      - name: Deploy updated services
        run: |
          echo "üîπ Redeploying updated services only..."

          MANIFEST=$(yq eval -o=json '.services' deployment-manifest.yaml)
          for service in $CHANGED_SERVICES; do
            IMAGE=$(echo "$MANIFEST" | jq -r ".\"$service\"")

            echo "üîÑ Deploying $service from $IMAGE ..."
            if ssh dokku@${{ secrets.DOKKU_HOST }} git:from-image "$service" "$IMAGE"; then
              echo "‚úÖ Deployment successful!"
            else
              echo "‚ö†Ô∏è Deployment failed ‚Äî app likely doesn't exist. Creating it..."
              ssh dokku@${{ secrets.DOKKU_HOST }} apps:create "$service"
              ssh dokku@${{ secrets.DOKKU_HOST }} network:set "$service" attach-post-create marche-conclu
              ssh dokku@${{ secrets.DOKKU_HOST }} network:rebuild "$service"
              echo "üîÅ Retrying deployment..."
              ssh dokku@${{ secrets.DOKKU_HOST }} git:from-image "$service" "$IMAGE"
              echo "‚úÖ Deployment complete!"
            fi
          done

          echo "‚úÖ Updated services deployed!"
